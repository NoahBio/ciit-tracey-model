"""
Test Script: Simple Marginal Probability Model

Tests client agent with history-based expectations using P(therapist_j)
(simple frequencies) combined with bond-based expectations.
"""

import numpy as np
import sys
from typing import List, Tuple, Optional


from src.agents.client_agent import ClientAgent, create_client
from src.config import OCTANT_NAMES



def get_complementary_action(client_action: int) -> int:
    """Get complementary therapist response."""
    complement_map = {
        0: 4,  # D → S
        1: 3,  # WD → WS
        2: 2,  # W → W
        3: 1,  # WS → WD
        4: 0,  # S → D
        5: 7,  # CS → CD
        6: 6,  # C → C
        7: 5   # CD → CS
    }
    return complement_map[client_action]


def calculate_client_specific_threshold(u_matrix: np.ndarray) -> float:
    """
    Calculate success threshold as 80th percentile of CLIENT-SPECIFIC u_matrix.
    This is the correct implementation - each client's threshold based on their own matrix.
    """
    rs_min = u_matrix.min()
    rs_max = u_matrix.max()
    threshold = rs_min + 0.8 * (rs_max - rs_min)
    return threshold


def simulate_therapy_simple_probabilities(
    pattern_type: str = "cold_stuck",
    max_sessions: int = 100,
    random_state: Optional[int] = None
) -> dict:
    """
    Simulate therapy with simple marginal probability model.
    """
    rng = np.random.RandomState(random_state)
    
    # Create client
    client = create_client(
        pattern_type=pattern_type,
        entropy=1.0,
        random_state=random_state
    )
    
    # Calculate CLIENT-SPECIFIC threshold
    client_threshold = calculate_client_specific_threshold(client.u_matrix)
    
    # Get initial state
    initial_rs = client.relationship_satisfaction
    initial_bond = client.bond
    
    # Track trajectory
    trajectory = {
        "sessions": [],
        "client_actions": [],
        "therapist_actions": [],
        "rs_values": [],
        "bond_values": [],
        "therapist_frequencies": []  # Track learned frequencies
    }
    
    # Simulate therapy
    outcome = "max_length"
    sessions_to_outcome = max_sessions
    
    for session in range(1, max_sessions + 1):
        # Get current therapist frequency distribution (what client has learned)
        therapist_freqs = client._calculate_marginal_frequencies()
        
        # Client selects action
        client_action = client.select_action()
        
        # Therapist uses "always complement" strategy
        therapist_action = get_complementary_action(client_action)
        
        # Update client
        client.update_memory(client_action, therapist_action)
        
        # Record trajectory
        trajectory["sessions"].append(session)
        trajectory["client_actions"].append(client_action)
        trajectory["therapist_actions"].append(therapist_action)
        trajectory["rs_values"].append(client.relationship_satisfaction)
        trajectory["bond_values"].append(client.bond)
        trajectory["therapist_frequencies"].append(therapist_freqs.copy())
        
        # Check for success (using CLIENT-SPECIFIC threshold!)
        if client.relationship_satisfaction >= client_threshold:
            outcome = "success"
            sessions_to_outcome = session
            break
        
        # Check for dropout
        if client.check_dropout():
            outcome = "dropout"
            sessions_to_outcome = session
            break
    
    return {
        "outcome": outcome,
        "sessions": sessions_to_outcome,
        "initial_rs": initial_rs,
        "initial_bond": initial_bond,
        "final_rs": trajectory["rs_values"][-1] if trajectory["rs_values"] else initial_rs,
        "final_bond": trajectory["bond_values"][-1] if trajectory["bond_values"] else initial_bond,
        "client_threshold": client_threshold,
        "trajectory": trajectory,
        "u_matrix": client.u_matrix
    }


def run_simple_probabilities_test(n_clients: int = 100):
    """Test simple marginal probabilities with always-complement strategy."""
    
    print("=" * 80)
    print("SIMPLE MARGINAL PROBABILITY TEST")
    print("=" * 80)
    print(f"Testing {n_clients} cold-stuck clients")
    print("Therapist strategy: Always complement")
    print("Model: P(therapist_j) + Bond-based expectations")
    print()
    
    rng = np.random.RandomState(42)
    
    results = {
        "success": 0,
        "dropout": 0,
        "max_length": 0,
        "sessions_list": [],
        "initial_rs_list": [],
        "final_rs_list": [],
        "threshold_list": []
    }
    
    # Track first 3 clients in detail
    detailed_results = []
    
    print("Running simulations...")
    for i in range(n_clients):
        result = simulate_therapy_simple_probabilities(
            pattern_type="cold_stuck",
            max_sessions=100,
            random_state=rng.randint(0, 1000000)
        )
        
        # Update counts
        results[result["outcome"]] += 1
        
        if result["outcome"] == "success":
            results["sessions_list"].append(result["sessions"])
        
        results["initial_rs_list"].append(result["initial_rs"])
        results["final_rs_list"].append(result["final_rs"])
        results["threshold_list"].append(result["client_threshold"])
        
        # Save first 3 for detailed analysis
        if i < 3:
            detailed_results.append(result)
    
    # Print results
    print("\n" + "=" * 80)
    print("OUTCOMES")
    print("=" * 80)
    print(f"Success:     {results['success']:3d} / {n_clients} ({100*results['success']/n_clients:5.1f}%)")
    print(f"Dropout:     {results['dropout']:3d} / {n_clients} ({100*results['dropout']/n_clients:5.1f}%)")
    print(f"Max length:  {results['max_length']:3d} / {n_clients} ({100*results['max_length']/n_clients:5.1f}%)")
    
    if results["sessions_list"]:
        print("\nSUCCESS STATISTICS:")
        print(f"  Mean sessions: {np.mean(results['sessions_list']):.1f}")
        print(f"  Median sessions: {np.median(results['sessions_list']):.1f}")
        print(f"  Min sessions: {np.min(results['sessions_list'])}")
        print(f"  Max sessions: {np.max(results['sessions_list'])}")
    
    print("\nCLIENT-SPECIFIC THRESHOLDS:")
    print(f"  Mean threshold: {np.mean(results['threshold_list']):.2f}")
    print(f"  Min threshold: {np.min(results['threshold_list']):.2f}")
    print(f"  Max threshold: {np.max(results['threshold_list']):.2f}")
    
    print("\nINITIAL CONDITIONS:")
    print(f"  Mean initial RS: {np.mean(results['initial_rs_list']):.2f}")
    print(f"  Mean initial bond: {np.mean([r['initial_bond'] for r in detailed_results]):.3f}")
    
    print("\nFINAL CONDITIONS:")
    print(f"  Mean final RS: {np.mean(results['final_rs_list']):.2f}")
    print(f"  Mean RS improvement: {np.mean(results['final_rs_list']) - np.mean(results['initial_rs_list']):.2f}")
    
    # Detailed analysis
    print("\n" + "=" * 80)
    print("DETAILED ANALYSIS (First 3 Clients)")
    print("=" * 80)
    
    for idx, result in enumerate(detailed_results, 1):
        traj = result["trajectory"]
        u_matrix = result["u_matrix"]
        
        print(f"\nClient {idx}:")
        print(f"  Outcome: {result['outcome']}")
        print(f"  Threshold (80th percentile): {result['client_threshold']:.2f}")
        print(f"  Initial RS: {result['initial_rs']:.2f}, Final RS: {result['final_rs']:.2f}")
        print(f"  Initial bond: {result['initial_bond']:.3f}, Final bond: {result['final_bond']:.3f}")
        print(f"  Sessions: {result['sessions']}")
        
        # Analyze cold-cold vs warm-warm utilities
        cold_comp = np.mean([u_matrix[5,7], u_matrix[6,6], u_matrix[7,5]])
        warm_comp = np.mean([u_matrix[2,2], u_matrix[1,3], u_matrix[3,1]])
        print(f"  Cold complementarity avg: {cold_comp:.2f}")
        print(f"  Warm complementarity avg: {warm_comp:.2f}")
        print(f"  Can reach threshold via cold alone? {cold_comp >= result['client_threshold']}")
        
        # Show trajectory
        print("\n  First 15 sessions:")
        print("  Sess | Client | Therapist |     RS |  Bond | P(cold) | P(warm)")
        print("  -----+--------+-----------+--------+-------+---------+--------")
        
        for i in range(min(15, len(traj["sessions"]))):
            sess = traj["sessions"][i]
            client_act = OCTANT_NAMES[traj["client_actions"][i]]
            ther_act = OCTANT_NAMES[traj["therapist_actions"][i]]
            rs = traj["rs_values"][i]
            bond = traj["bond_values"][i]
            
            # Therapist frequency for cold (sum of CS, C, CD)
            freqs = traj["therapist_frequencies"][i]
            p_cold = freqs[5] + freqs[6] + freqs[7]
            p_warm = freqs[1] + freqs[2] + freqs[3]
            
            print(f"  {sess:4d} | {client_act:6s} | {ther_act:9s} | "
                  f"{rs:6.1f} | {bond:5.3f} | {p_cold:7.3f} | {p_warm:6.3f}")
        
        # Behavioral distribution
        cold_octants = [5, 6, 7]
        warm_octants = [1, 2, 3]
        total = len(traj["client_actions"])
        
        client_cold = sum(1 for a in traj["client_actions"] if a in cold_octants)
        client_warm = sum(1 for a in traj["client_actions"] if a in warm_octants)
        
        print(f"\n  Client behavior distribution:")
        print(f"    Cold octants (CS,C,CD): {client_cold}/{total} ({100*client_cold/total:.1f}%)")
        print(f"    Warm octants (WD,W,WS): {client_warm}/{total} ({100*client_warm/total:.1f}%)")
    
    # Interpretation
    print("\n" + "=" * 80)
    print("INTERPRETATION")
    print("=" * 80)
    
    success_rate = 100 * results['success'] / n_clients
    print(f"Success rate: {success_rate:.1f}%")
    print()
    
    if success_rate > 70:
        print("❌ STILL TOO EASY")
        print("   Simple probabilities + bond not creating enough difficulty")
        print()
        print("   ANALYSIS:")
        # Check if clients can reach threshold via cold complementarity
        cold_can_reach = sum(
            1 for r in detailed_results 
            if np.mean([r['u_matrix'][5,7], r['u_matrix'][6,6], r['u_matrix'][7,5]]) >= r['client_threshold']
        )
        print(f"   Clients where cold comp can reach threshold: {cold_can_reach}/{len(detailed_results)}")
        
        if cold_can_reach == 0:
            print("   → Clients MUST leave cold space to succeed")
            print("   → Success suggests they're exploring naturally (stochastic softmax)")
            print()
            print("   NEXT STEPS:")
            print("   1. Add behavioral inertia to prevent easy exploration")
            print("   2. OR: Implement therapist interpersonal costs")
            print("   3. OR: Accept this as realistic (bond enables flexibility)")
        else:
            print("   → Some clients can reach threshold via cold comp alone")
            print("   → Need stronger mechanism to force behavioral change")
    
    elif success_rate < 30:
        print("❌ TOO HARD")
        print("   Model may be over-correcting")
    
    else:
        print("✅ GOOD DIFFICULTY")
        print("   Success rate in target range (30-70%)")
        print("   Ready for RL training")
    
    print("=" * 80)


if __name__ == "__main__":
    print("Running simple marginal probability test...")
    print()
    
    run_simple_probabilities_test(n_clients=100)